{% extends 'index.html' %}

{% block contenido %}
<div class="section-header">
    <h2>Crear Libro</h2>
</div>

<!-- Sección de Búsqueda Rápida por ISBN -->
<div class="card" style="margin-bottom: 2rem; padding: 1rem; border: 1px solid #333; border-radius: 8px;">
    <h3>Autocompletar con OpenLibrary</h3>
    <div style="display: flex; gap: 10px;">
        <input type="text" id="api_isbn" placeholder="Ingresa ISBN para buscar..." style="flex: 1;">
        <button type="button" onclick="buscarISBN()" style="width: auto;">Buscar</button>
    </div>
    <small style="color: #888;">Ingresa el ISBN y pulsa Buscar para rellenar los datos automáticamente.</small>
</div>

<!-- Mensaje de Advertencia de Duplicado -->
{% if advertencia_duplicado %}
<div
    style="background-color: #ffd700; color: #000; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #b8860b;">
    <h4>⚠️ ¡Advertencia: Posible Libro Duplicado!</h4>
    <p>Ya existe un libro registrado con el ISBN <strong>{{ isbn_duplicado }}</strong> con el título "<strong>{{
            titulo_existente }}</strong>".</p>
    <p>¿Estás seguro de que deseas registrar este libro nuevamente?</p>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Input oculto para confirmar duplicado -->
    {% if advertencia_duplicado %}
    <input type="hidden" name="confirmar_duplicado" value="true">
    {% endif %}

    <label for="id_isbn">ISBN (Opcional)</label>
    <input type="text" id="id_isbn" name="isbn" value="{{ request.POST.isbn|default:'' }}">
    <!-- URL oculta para la imagen de la API -->
    <input type="hidden" id="id_cover_url" name="cover_url">

    <label for="id_titulo">Titulo</label>
    <input type="text" id="id_titulo" name="titulo" required value="{{ request.POST.titulo|default:'' }}">

    <label for="id_autor_texto">Autor (Nombre Completo)</label>
    <div style="display: flex; gap: 5px; margin-bottom: 1rem;">
        <input type="text" id="id_autor_texto" name="autor_texto" placeholder="Escribe el nombre del autor..."
            value="{{ request.POST.autor_texto|default:'' }}">
        <select name="autor_select" id="id_autor_select" onchange="copiarAutor()" style="width: 30%;">
            <option value="">-- Existentes --</option>
            {% for autor in autores %}
            <option value="{{ autor.nombre }} {{ autor.apellido }}">
                {{ autor.nombre }} {{ autor.apellido }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div style="margin-bottom: 1rem;">
        <label for="id_stock">Stock (Cantidad de Copias)</label>
        <input type="number" id="id_stock" name="stock" value="{{ request.POST.stock|default:'1' }}" min="1" required
            style="width: 100px;">
    </div>

    <div style="margin-bottom: 1rem;">
        <label for="id_categoria">Categoría</label>
        <select name="categoria" id="id_categoria">
            <option value="">-- Sin Categoría --</option>
            {% for cat in categorias %}
            <option value="{{ cat.id }}">{{ cat.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <label for="id_bibliografia">Bibliografia</label>
    <textarea id="id_bibliografia" name="bibliografia" rows="3">{{ request.POST.bibliografia|default:'' }}</textarea>

    <label for="id_imagen">Imagen: </label>
    <!-- Contenedor para previsualizar imagen de API -->
    <div id="preview_container" style="display: none; margin-bottom: 1rem;">
        <p>Imagen desde API:</p>
        <img id="img_preview" src="" style="max-width: 100px; border: 1px solid #ccc;">
    </div>
    <input type="file" id="id_imagen" name="imagen" accept="image/*">
    <br><br>

    <div style="display: flex; gap: 1rem;">
        <button type="submit" name="accion" value="guardar">Guardar Libro</button>
        {% if advertencia_duplicado %}
        <a href="{% url 'crear_libros' %}" class="button"
            style="background-color: #f44336; padding: 0.8rem; text-decoration: none; color: white; border-radius: 4px;">Cancelar</a>
        {% endif %}
    </div>
</form>

<script>
    // Pequeño script para rellenar campos desde el select de autores
    function copiarAutor() {
        var select = document.getElementById("id_autor_select");
        var input = document.getElementById("id_autor_texto");
        if (select.value) {
            input.value = select.value;
        }
    }

    // Funcionalidad AJAX simple para buscar ISBN sin recargar
    async function buscarISBN() {
        const isbn = document.getElementById('api_isbn').value;
        if (!isbn) return;

        const btn = document.querySelector('button[onclick="buscarISBN()"]');
        btn.textContent = "Buscando...";
        btn.disabled = true;

        try {
            // Usamos la misma lógica del servicio pero llamada asíncrona simulada o endpoint API
            // Para simplificar, haremos fetch directo a OpenLibrary cliente
            const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
            const data = await response.json();
            const bookData = data[`ISBN:${isbn}`];

            if (bookData) {
                document.getElementById('id_isbn').value = isbn;
                document.getElementById('id_titulo').value = bookData.title;

                if (bookData.authors && bookData.authors.length > 0) {
                    document.getElementById('id_autor_texto').value = bookData.authors[0].name;
                }

                if (bookData.cover) {
                    const coverUrl = bookData.cover.medium || bookData.cover.large;
                    document.getElementById('id_cover_url').value = coverUrl;
                    document.getElementById('img_preview').src = coverUrl;
                    document.getElementById('preview_container').style.display = 'block';
                }
            } else {
                alert("No se encontró libro con ese ISBN en OpenLibrary.");
            }
        } catch (error) {
            console.error(error);
            alert("Error al conectar con el servicio.");
        } finally {
            btn.textContent = "Buscar";
            btn.disabled = false;
        }
    }
</script>
{% endblock %}